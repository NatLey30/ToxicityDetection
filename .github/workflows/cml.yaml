name: Train Model with DVC + MLflow (DagsHub)

on:
  push:
  pull_request:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # -----------------------------
    # INSTALL PYTHON
    # -----------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # -----------------------------
    # INSTALL DVC WITH S3 SUPPORT
    # -----------------------------
    - name: Install DVC
      run: |
        pip install "dvc[s3]"
    
    # -----------------------------
    # CONFIGURE GIT (required by DVC)
    # -----------------------------
    - name: Configure Git
      run: |
        git config --global user.email "202108204@alu.comillas.edu"
        git config --global user.name "NatLey30"

    # -----------------------------
    # RESTORE DVC CACHE (optional optimization)
    # -----------------------------
    - name: Restore DVC cache
      uses: actions/cache@v3
      with:
        path: ~/.cache/dvc
        key: dvc-cache-${{ hashFiles('dvc.yaml', 'dvc.lock') }}
        restore-keys: |
          dvc-cache-

    # -----------------------------
    # DVC PULL (PRIVATE DAGSHUB BUCKET)
    # -----------------------------
    - name: DVC Pull
      env:
        DAGSHUB_API_KEY: ${{ secrets.DAGSHUB_API_KEY }}
      run: |
        # Insert Dagshub credentials into dvc config.local
        dvc remote modify origin --local access_key_id $DAGSHUB_API_KEY
        dvc remote modify origin --local secret_access_key $DAGSHUB_API_KEY
        
        # Pull data from DagsHub remote
        dvc pull -r origin

    # -----------------------------
    # INSTALL DEPENDENCIES
    # -----------------------------
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install pyyaml
        pip install -r requirements.txt

    # -----------------------------
    # SETUP CML (OPTIONAL: REPORTS)
    # -----------------------------
    - uses: iterative/setup-cml@v1

    # -----------------------------
    # TRAIN THE MODEL WITH MLFLOW LOGGING
    # -----------------------------
    - name: Run script
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_API_KEY }}
      run: |
        dvc repro